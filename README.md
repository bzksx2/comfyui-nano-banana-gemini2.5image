# Gemini ComfyUI Plugin

ä¸€ä¸ªå¼ºå¤§çš„ ComfyUI æ’ä»¶ï¼Œé›†æˆ Google Gemini API çš„å›¾åƒç”Ÿæˆå’Œç¼–è¾‘åŠŸèƒ½ã€‚æ”¯æŒçº¯æ–‡æœ¬ç”Ÿæˆå›¾åƒå’ŒåŸºäºç°æœ‰å›¾åƒçš„æ™ºèƒ½ç¼–è¾‘ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ğŸ¨ **å›¾åƒç”Ÿæˆ**: ä½¿ç”¨ Gemini æ¨¡å‹ä»æ–‡æœ¬æç¤ºç”Ÿæˆé«˜è´¨é‡å›¾åƒ
- ğŸ–¼ï¸ **å›¾åƒç¼–è¾‘**: åŸºäºè¾“å…¥å›¾åƒå’Œæ–‡æœ¬æŒ‡ä»¤è¿›è¡Œæ™ºèƒ½ç¼–è¾‘
- ğŸŒ **é•œåƒç«™æ”¯æŒ**: æ”¯æŒè‡ªå®šä¹‰APIåœ°å€ï¼Œé€‚é…å›½å†…é•œåƒç«™å’Œä»£ç†æœåŠ¡
- ğŸ”„ **æ™ºèƒ½é‡è¯•**: å†…ç½®é™æµå¤„ç†å’Œé”™è¯¯æ¢å¤æœºåˆ¶
- ğŸš€ **å¤šæ¨¡å‹æ”¯æŒ**: æ”¯æŒæœ€æ–°çš„ Gemini 2.5 å’Œ 2.0 æ¨¡å‹
- ğŸ›¡ï¸ **ç¨³å®šæ€§**: å¢å¼ºçš„é”™è¯¯å¤„ç†å’Œè¶…æ—¶ç®¡ç†

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### è·å– API Key

1. è®¿é—® [Google AI Studio](https://makersuite.google.com/app/apikey)
2. åˆ›å»ºæ–°çš„ API Key
3. åœ¨èŠ‚ç‚¹ä¸­è¾“å…¥ä½ çš„ API Key

## ğŸ“¦ èŠ‚ç‚¹è¯´æ˜

### Gemini å›¾ç‰‡ç”Ÿæˆ (GeminiImageGeneration)

ä»æ–‡æœ¬æç¤ºç”Ÿæˆå…¨æ–°å›¾åƒã€‚

**è¾“å…¥å‚æ•°:**
- `api_key`: Google Gemini API å¯†é’¥
- `prompt`: å›¾åƒç”Ÿæˆæç¤ºè¯
- `model`: é€‰æ‹©æ¨¡å‹ (gemini-2.5-flash-image-preview æˆ– gemini-2.0-flash-preview-image-generation)
- `temperature`: åˆ›é€ æ€§æ§åˆ¶ (0.0-2.0)
- `top_p`: é‡‡æ ·æ§åˆ¶ (0.0-1.0)
- `max_output_tokens`: æœ€å¤§è¾“å‡ºä»¤ç‰Œæ•°

**è¾“å‡º:**
- `image`: ç”Ÿæˆçš„å›¾åƒ (IMAGE ç±»å‹)
- `response_text`: API å“åº”æ–‡æœ¬

### Gemini å›¾ç‰‡ç¼–è¾‘ (GeminiImageEdit)

åŸºäºè¾“å…¥å›¾åƒè¿›è¡Œæ™ºèƒ½ç¼–è¾‘ï¼Œæ”¯æŒå•å›¾å’Œå¤šå›¾æ‰¹é‡å¤„ç†ã€‚

**è¾“å…¥å‚æ•°:**
- `api_key`: Google Gemini API å¯†é’¥
- `images`: è¾“å…¥å›¾åƒ (IMAGE ç±»å‹ï¼Œæ”¯æŒæ‰¹é‡)
- `prompt`: ç¼–è¾‘æŒ‡ä»¤
- `model`: é€‰æ‹©æ¨¡å‹
- `temperature`: åˆ›é€ æ€§æ§åˆ¶
- `top_p`: é‡‡æ ·æ§åˆ¶
- `max_output_tokens`: æœ€å¤§è¾“å‡ºä»¤ç‰Œæ•°
- `process_mode`: å¤„ç†æ¨¡å¼
  - `each_image_separately`: åˆ†åˆ«å¤„ç†æ¯å¼ å›¾ç‰‡ (é»˜è®¤)
  - `all_images_combined`: æ‰€æœ‰å›¾ç‰‡åˆå¹¶å¤„ç†
  - `first_image_only`: ä»…å¤„ç†ç¬¬ä¸€å¼ å›¾ç‰‡

**è¾“å‡º:**
- `edited_image`: ç¼–è¾‘åçš„å›¾åƒ (IMAGE ç±»å‹)
- `response_text`: API å“åº”æ–‡æœ¬

**å¤„ç†æ¨¡å¼è¯´æ˜:**
- **each_image_separately**: å¯¹æ¯å¼ å›¾ç‰‡å•ç‹¬å¤„ç†ï¼Œé€‚åˆä¸ªæ€§åŒ–ç¼–è¾‘
- **all_images_combined**: å°†æ‰€æœ‰å›¾ç‰‡ä¸€èµ·å¤„ç†ï¼Œé€‚åˆä¿æŒé£æ ¼ä¸€è‡´æ€§
- **first_image_only**: åªå¤„ç†ç¬¬ä¸€å¼ å›¾ç‰‡ï¼Œé€‚åˆå¿«é€Ÿæµ‹è¯•

### Gemini é•œåƒç«™å›¾ç‰‡ç”Ÿæˆ (GeminiMirrorImageGeneration)

æ”¯æŒè‡ªå®šä¹‰APIåœ°å€çš„å›¾åƒç”ŸæˆèŠ‚ç‚¹ï¼Œé€‚é…å›½å†…é•œåƒç«™ã€‚

**è¾“å…¥å‚æ•°:**
- `api_url`: è‡ªå®šä¹‰APIåœ°å€ (å¦‚: https://ai.comfly.chat)
- `api_key`: API å¯†é’¥
- `prompt`: å›¾åƒç”Ÿæˆæç¤ºè¯
- `model`: é€‰æ‹©æ¨¡å‹
- `temperature`: åˆ›é€ æ€§æ§åˆ¶
- `top_p`: é‡‡æ ·æ§åˆ¶
- `max_output_tokens`: æœ€å¤§è¾“å‡ºä»¤ç‰Œæ•°

**è¾“å‡º:**
- `image`: ç”Ÿæˆçš„å›¾åƒ (IMAGE ç±»å‹)
- `response_text`: API å“åº”æ–‡æœ¬

### Gemini é•œåƒç«™å›¾ç‰‡ç¼–è¾‘ (GeminiMirrorImageEdit)

æ”¯æŒè‡ªå®šä¹‰APIåœ°å€çš„å›¾åƒç¼–è¾‘èŠ‚ç‚¹ï¼Œé€‚é…å›½å†…é•œåƒç«™ã€‚

**è¾“å…¥å‚æ•°:**
- `api_url`: è‡ªå®šä¹‰APIåœ°å€ (å¦‚: https://ai.comfly.chat)
- `api_key`: API å¯†é’¥
- `image`: è¾“å…¥å›¾åƒ (IMAGE ç±»å‹)
- `prompt`: ç¼–è¾‘æŒ‡ä»¤
- `model`: é€‰æ‹©æ¨¡å‹
- `temperature`: åˆ›é€ æ€§æ§åˆ¶
- `top_p`: é‡‡æ ·æ§åˆ¶
- `max_output_tokens`: æœ€å¤§è¾“å‡ºä»¤ç‰Œæ•°

**è¾“å‡º:**
- `edited_image`: ç¼–è¾‘åçš„å›¾åƒ (IMAGE ç±»å‹)
- `response_text`: API å“åº”æ–‡æœ¬

### é•œåƒç«™æ–‡ç”Ÿå›¾ (NanoBananaTextToImage)

ä½¿ç”¨é•œåƒç«™APIè¿›è¡Œæ–‡æœ¬åˆ°å›¾åƒç”Ÿæˆï¼ŒåŸºäº https://ai.comfly.chat é•œåƒç«™ã€‚

**è¾“å…¥å‚æ•°:**
- `api_key`: API å¯†é’¥
- `prompt`: å›¾åƒç”Ÿæˆæç¤ºè¯
- `model`: æ¨¡å‹åç§° (é»˜è®¤: nano-banana)
- `response_format`: å“åº”æ ¼å¼ (url æˆ– b64_json)
- `seed`: éšæœºç§å­ (-1è¡¨ç¤ºä½¿ç”¨éšæœºç§å­)

**è¾“å‡º:**
- `image`: ç”Ÿæˆçš„å›¾åƒ (IMAGE ç±»å‹)
- `info`: API å“åº”æ–‡æœ¬
- `seed`: ä½¿ç”¨çš„éšæœºç§å­å€¼

### é•œåƒç«™å›¾ç”Ÿå›¾ (NanoBananaImageToImage)

ä½¿ç”¨é•œåƒç«™APIè¿›è¡Œå›¾åƒç¼–è¾‘ï¼Œæ”¯æŒå¤šå›¾å¤„ç†ã€‚

**è¾“å…¥å‚æ•°:**
- `api_key`: API å¯†é’¥
- `images`: è¾“å…¥å›¾åƒ (IMAGE ç±»å‹)
- `prompt`: ç¼–è¾‘æŒ‡ä»¤
- `model`: æ¨¡å‹åç§° (é»˜è®¤: nano-banana)
- `response_format`: å“åº”æ ¼å¼ (url æˆ– b64_json)
- `seed`: éšæœºç§å­ (-1è¡¨ç¤ºä½¿ç”¨éšæœºç§å­)

**è¾“å‡º:**
- `image`: ç¼–è¾‘åçš„å›¾åƒ (IMAGE ç±»å‹)
- `info`: API å“åº”æ–‡æœ¬
- `seed`: ä½¿ç”¨çš„éšæœºç§å­å€¼

## ğŸ”§ æŠ€æœ¯ç‰¹æ€§

### æ™ºèƒ½é‡è¯•æœºåˆ¶

- **æŒ‡æ•°é€€é¿**: è‡ªåŠ¨è°ƒæ•´é‡è¯•é—´éš”
- **é™æµå¤„ç†**: é’ˆå¯¹ 429 é”™è¯¯çš„ç‰¹æ®Šå¤„ç†
- **é”™è¯¯åˆ†ç±»**: æ ¹æ®ä¸åŒé”™è¯¯ç±»å‹é‡‡ç”¨ä¸åŒç­–ç•¥

### å›¾åƒå¤„ç†

- **æ ¼å¼è½¬æ¢**: è‡ªåŠ¨å¤„ç† RGB/RGBA è½¬æ¢
- **Base64 ç¼–ç **: é«˜æ•ˆçš„å›¾åƒæ•°æ®ä¼ è¾“
- **è´¨é‡ä¼˜åŒ–**: 95% JPEG è´¨é‡ä¿è¯

### é”™è¯¯å¤„ç†

- **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„æ“ä½œè¿‡ç¨‹è®°å½•
- **å‹å¥½æç¤º**: æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®
- **ä¼˜é›…é™çº§**: å¤±è´¥æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ

## ğŸ“‹ ä¾èµ–é¡¹

```
torch>=1.9.0          # æ·±åº¦å­¦ä¹ æ¡†æ¶
numpy>=1.21.0         # æ•°å€¼è®¡ç®—
Pillow>=8.0.0         # å›¾åƒå¤„ç†
requests>=2.25.0      # HTTP è¯·æ±‚

# å¯é€‰ä¾èµ–ï¼ˆä»…å½“ä½¿ç”¨Google APIæ—¶éœ€è¦ï¼‰
# google-genai>=0.3.0   # Google AI SDK
# google-cloud-aiplatform>=1.25.0
# google-auth>=2.0.0
# google-auth-oauthlib>=0.5.0
```

## ğŸ› ï¸ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€å›¾åƒç”Ÿæˆ

```python
# åœ¨ ComfyUI ä¸­æ·»åŠ  "Gemini å›¾ç‰‡ç”Ÿæˆ" èŠ‚ç‚¹
# è®¾ç½®å‚æ•°:
api_key = "your_gemini_api_key"
prompt = "A serene mountain landscape at sunset with a lake reflection"
model = "gemini-2.5-flash-image-preview"
```

### å›¾åƒç¼–è¾‘

```python
# åœ¨ ComfyUI ä¸­æ·»åŠ  "Gemini å›¾ç‰‡ç¼–è¾‘" èŠ‚ç‚¹
# è¿æ¥è¾“å…¥å›¾åƒå¹¶è®¾ç½®å‚æ•°:
prompt = "Add a rainbow in the sky"
```

### ä½¿ç”¨é•œåƒç«™

```python
# åœ¨ ComfyUI ä¸­æ·»åŠ  "Gemini é•œåƒç«™å›¾ç‰‡ç”Ÿæˆ" èŠ‚ç‚¹
# è®¾ç½®è‡ªå®šä¹‰APIåœ°å€:
api_url = "https://ai.comfly.chat"  # æˆ–å…¶ä»–é•œåƒç«™åœ°å€
api_key = "your_api_key"
prompt = "A beautiful sunset over the ocean"
```

### ä½¿ç”¨é•œåƒç«™API

```python
# åœ¨ ComfyUI ä¸­æ·»åŠ  "é•œåƒç«™æ–‡ç”Ÿå›¾" èŠ‚ç‚¹
# ä½¿ç”¨é•œåƒç«™API:
api_key = "your_api_key"
prompt = "ä¸€åªå¯çˆ±çš„çŒ«å’ª"
model = "nano-banana"
response_format = "b64_json"
seed = 42  # ä½¿ç”¨å›ºå®šç§å­ä»¥è·å¾—ä¸€è‡´çš„ç»“æœ
```

## ğŸŒ æ”¯æŒçš„é•œåƒç«™

æ’ä»¶æ”¯æŒä¸¤ç§APIæ ¼å¼çš„é•œåƒç«™ï¼š

### Gemini åŸç”Ÿæ ¼å¼é•œåƒç«™
- `https://ai.comfly.chat` - ComflyAI é•œåƒç«™
- `https://api.openai-proxy.com` - ä»£ç†æœåŠ¡
- å…¶ä»–å…¼å®¹ Gemini API æ ¼å¼çš„é•œåƒæœåŠ¡

### é•œåƒç«™API (OpenAIå…¼å®¹æ ¼å¼)
- `https://ai.comfly.chat` - æ”¯æŒOpenAIå…¼å®¹æ ¼å¼çš„é•œåƒç«™
- æ–‡ç”Ÿå›¾ API: `/v1/images/generations`
- å›¾ç”Ÿå›¾ API: `/v1/images/edits`
- æ¨¡å‹: gemini-2.5-flash-image-preview

### é•œåƒç«™APIé…ç½®è¯´æ˜

1. **API åœ°å€**: é»˜è®¤ä½¿ç”¨ `https://ai.comfly.chat`
   - æ–‡ç”Ÿå›¾: `https://ai.comfly.chat/v1/images/generations`
   - å›¾ç”Ÿå›¾: `https://ai.comfly.chat/v1/images/edits`

2. **æ¨¡å‹é€‰æ‹©**: ä½¿ç”¨ `nano-banana` æ¨¡å‹
   - åŸºäº Gemini 2.5 Flash Image Preview
   - æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡æç¤ºè¯
   - ä¼˜åŒ–çš„å›¾åƒç”Ÿæˆå’Œç¼–è¾‘èƒ½åŠ›

3. **å“åº”æ ¼å¼**: 
   - `b64_json`: è¿”å› base64 ç¼–ç çš„å›¾ç‰‡æ•°æ® (æ¨è)
   - `url`: è¿”å›å›¾ç‰‡ URL é“¾æ¥

4. **éšæœºç§å­**:
   - `-1`: ä½¿ç”¨éšæœºç§å­ (æ¯æ¬¡ç”Ÿæˆä¸åŒç»“æœ)
   - ç‰¹å®šå€¼: ä½¿ç”¨å›ºå®šç§å­ (å¯é‡ç°ç›¸åŒç»“æœ)

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **API é…é¢**: æ³¨æ„ API çš„ä½¿ç”¨é™åˆ¶
2. **ç½‘ç»œè¿æ¥**: ç¡®ä¿ç¨³å®šçš„ç½‘ç»œè¿æ¥
3. **å›¾åƒå¤§å°**: å¤§å›¾åƒå¯èƒ½éœ€è¦æ›´é•¿å¤„ç†æ—¶é—´
4. **æ¨¡å‹é€‰æ‹©**: ä¸åŒæ¨¡å‹æœ‰ä¸åŒçš„ç‰¹æ€§å’Œé™åˆ¶

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**API Key é”™è¯¯**
- ç¡®ä¿ API Key æ ¼å¼æ­£ç¡®ä¸”æœ‰æ•ˆ
- æ£€æŸ¥ API Key æƒé™è®¾ç½®

**429 é™æµé”™è¯¯**
- ç­‰å¾…æ›´é•¿æ—¶é—´å†è¯•
- æ£€æŸ¥ API é…é¢è®¾ç½®
- è€ƒè™‘å‡çº§ API è®¡åˆ’

**ç½‘ç»œè¶…æ—¶**
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- å¢åŠ è¶…æ—¶æ—¶é—´è®¾ç½®

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªå¼€æºè®¸å¯è¯ã€‚ä½¿ç”¨å‰è¯·ç¡®ä¿éµå®ˆç›¸å…³APIçš„ä½¿ç”¨æ¡æ¬¾ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ï¼

---

**æ³¨æ„**: ä½¿ç”¨æœ¬æ’ä»¶éœ€è¦æœ‰æ•ˆçš„APIå¯†é’¥ã€‚è¯·ç¡®ä¿éµå®ˆç›¸å…³çš„ä½¿ç”¨æ¡æ¬¾å’Œé™åˆ¶ã€‚